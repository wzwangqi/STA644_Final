---
title: "Global Terrorist Activities Time Series Analysis and Iraq Spatial Case Study"
author: "Yuan Gao, Qi Wang, Yizheng Wang, Darien Zhang"
date: "4/21/2017"
output: pdf_document
---

## Introduction

This project aims to explore and analyze the dataset from Global Terrorism Database that contains details on every terrorist activity since 1970. There are two parts of the project. The first part is creating ARIMA models for aggregated count data for terrorist activities in each region of the world and forecasting for the future years. 


The second part is mainly focus on the spatial pattern of these terroristic attacks in Iraq which has sufferd the most from the terrorism: over 18000 attacks took place in Iraq from 1970 to 2015. In addition, we also incorporate the civilian deaths statistics from Iraq Body Count website, which could be used to do infernce between the number of attacks and total civilian deaths from violence. In order to capture the spatial patterns, some spatial models which include SAR, CAR and their corresponding bayesian version models has then been implemented. In the GTD dataset, there is a categorical varible which is called `success`. Success of a terrorist strike is defined according to the tangible effects of the attack, which is used to describe whether the incident was successful. Based on this information, we also fit a spline model which can be used to predict whether or not the attack type took place in each area of Iraq.

## Data
The Global Terrorism Database (GTD) is maintained by the National Consortium for the Study of Terrorism and Responses to Terrorism (START). The database collects from media articles and electronic archives, and to a lesser extent, existing data sets, secondary source materials such as books and journals, and legal documents. Each row represents one terrorist incident, and the variables include incident date, incident information, incident location, attack information, weapon information, target information, and perpetrator information. There are 156,772 incidents ranging from 1970 to 2015. The GTD defines a terrorist attack as the threatened or actual use of illegal force and violence by a non\-state actor to attain a political, economic, religious, or social goal through fear, coercion, or intimidation. In order to consider an incident for inclusion in the GTD, all three of the following attributes must be present: the incident must be intentional, the incident must entail some level of violence or immediate threat of violence, and the perpetrators of the incidents must be sub\-national actors. Incidents occurring in both the same geographic and temporal point will be regarded as a single incident, but if either the time of occurrence of incidents or their locations are discontinuous, the events will be regarded as separate incidents.


Iraq Body Count(IBC) maintains the world's lagest public database of violent civilian deaths. Its data drawn from cross-checked media reports, hospital, morgue, NGO and official figures or records. IBC can allow user to specify the number of civilian deathes for each province. Hence, we are able to cumulatively sum the number of civilian deaths for each province of Iraq and use these data fit models.

## Methodology

Originated from time series analysis, *Simultaneous Autoregressive (SAR)* model and *Conditional Autoregressive (CAR)* model have been applied and extended by different fields such as econometrics, geography and medical statistics. Analogy to *Autoregressive model*, the CAR and SAR models include spatial neighboring observations. Here we fit the SAR and CAR model by both Frequentist and Bayesian way to discover spatial patterns of terroristic attacks in Iraq.

Similar to kernel regression and k-nearest-neigbors regression, *Smoothing Spline* model is able to flexibly estimate underlying regression function $f(x)$. We used *Smoothing Spline* model to discover how ``successful terroristic attack'' distributes in Iraq.

### SAR and CAR

For every spatial data point $s$, *Simultaneous Autoregressive* assumes:

$$ y(s) = \phi \sum_{s'} \frac{W_{s\,s'}}{W_{s\,\boldsymbol{\cdot}}} y(s') + \epsilon $$

$$ {y} \sim \mathcal{N}(0,~\sigma^2 \, (({I}-\phi {W})^{-1}) (({I}-\phi {W})^{-1})^t )$$

*Conditional Autoregressive* assumes:

$$ y(s)|{y}_{-s} \sim \mathcal{N}\left(\sum_{s'} \frac{W_{s\,s'}}{W_{s\,\boldsymbol{\cdot}}} y(s'),~ \sigma^2 \right) $$

$$ {y} \sim \mathcal{N}(0,~\sigma^2 \, ({I}-\phi {W})^{-1})$$

Where $W$ is weight matrices and $\sigma^2$ is variance. 

### Spline 

Spline provides a flexible way of estimating the underlying regression function $r(x)=E(Y|X=x)$. It estimates values using a mathematical function that minimizes overall surface curvature. This results in a smooth surface that passes exactly through the input points. In the spatio context, It can predict ridges and valleys in the data and is the best method for representing the smoothly varying surfaces(Childs, 2014). The general spline formular is as following:$$S(x,y)=T(x,y)+\sum_{j=1}^{N}\lambda_jR(r_j),$$where N is the number of points, $\lambda$ is the coefficients, and $r_j$ is the distance from the point (x,y) to the $j^{th}$ point. $T(x,y)$ and $R(r)$ represent tension option and regularized option, respectively. They are defined differently and really depend on the specific context.

## Result

### Part I: Regional Time Series Analysis

The first part of the project is to build ARIMA models for all twelve regions on aggregated counts of the incidents and perform forecasts for the next several years. We performed the analysis on both yearly and monthly aggregated count data.

Looking at the plot of the original data, we can see that there is obvious drift in the original time series. For fulfilling stationarity, we have visualize the difference of the original data. After differencing, the data does seem to appear to have a mean at 0. Corresponding ACF and PACF are also plotted for modeling. Periodograms are plotted, and they can be used to identify the dominant periods (or frequencies) of a time series.  Periodogram is a helpful tool in spectral analysis to detect cyclical behavior. Typically the time series are observed in time domain, but it can also be transformed to the frequency domain by Fourier Transforamtion. If there is significant peak at certain frequency, there may be significant periodicity in the series.

Based on observing the ACF, PACF and periodogram, by grid searching on a small range, here we have presented the best models. For the models based on yearly data, they turn out to have relatively low AIC values and the residuals are not autocorrelated. Thus, the models are good enough for us to use for forecast. For the monthly data, the residuals are not behaving as nicely looking at the acf and pacfs, and further tuning or more complicated models could be used to enhance the performance in the future.

The forecasted trends seem to match up with our expectations of the number of terrorist attacks in the region. For instance, due to influx of refugees to Western Europe and complexity in the international politics of the region, an increase in the number of terrorist incidents could be expected in Western Europe as indicated by the model. However, we need to keep in mind that terrorist attacks have complicated motives and are triggered by many elements and the models are merely a quick look at the trends to provide some insights in the matter. 

### Part II: Iraq Spatial Analysis

#### Spatial Autocorrelation
Before we apply any statistical model to detect spatial pattern of terroristic attacks in Iraq, we use *Moran's I* and *Geary's C* to measure spatial autocorrelation of terroristic attack observation in Iraq.

Values of Moran's I range from $-1$ to $+1$. Negative values indicate negative spatial autocorrelation and positive values indicate positive spatial autocorrelation. A zero value indicates a random spatial pattern. 

The value of Geary's C lies between 0 and 2. 1 means no spatial autocorrelation. Values lower than 1 demonstrate increasing positive spatial autocorrelation, whilst values higher than 1 illustrate increasing negative spatial autocorrelation.

| Measurement   | Value         |
| ------------- |:-------------:|
| Moran's I     | 0.27          | 
| Geary's C     | 0.77          |
Table: Measurement of Spatial Autocorrelation

In our Iraq terroristic attack dataset, we calculate its Moran's I and Geary's C. Table.1 shows thers is spatial pattern among the observations. Therefore, we decide to fit the *CAR*, *SAR* and *Spline* models to explore terroristic attacks in Iraq. 
```{r, message=FALSE, warning=FALSE, echo=FALSE}
# Load packages
library(dplyr)
library(forecast)
library(ggplot2)
library(modelr)
library(tidyr)
library(readr)
library(spdep)
library(magrittr)
library(dplyr)
library(modelr)
library(ggplot2)
library(tidyr)
library(rjags)
library(stringr)
library(gridExtra)
library(readr)
library(purrr)
library(forcats)
library(forecast)
library(astsa)
library(fields)
library(readr)
library(sf)
globalterrorismdb_0616dist = readr::read_csv("~/Documents/Study/2016Summer/Terrorism/GTD_0616dist/globalterrorismdb_0616dist.csv")
load("/Users/andrea/Documents/Study/2017Spring/STA644/iraq1.RData")
W = 1*st_touches(irq1$geometry, sparse=FALSE)
listW = mat2listw(W)

```


####Sar model with population density as predictor
In the GTD dataset, most of columns are categorical variables, which can not be used as the predictors in this context. Based on our common knowledge, we consider that most of terroristic attacks took place in high population density area in order to reach their goal: attracting more attention from others. Therefore, we first use population density of each province in Iraq as the predictor to predict the number of attacks.
```{r, message=FALSE, warning=FALSE, echo=FALSE}
irq_sar_pop = spautolm(formula = count ~ density11, data = irq1, 
                  listw = listW, family = "SAR")
irq1$sar_pred_pop = irq_sar_pop$fit$fitted.values

irq1$sar_resid_pop = irq_sar_pop$fit$residuals
grid.arrange(
ggplot() + geom_sf(data=irq1, aes(fill=count)) + ggtitle("Number of Attacks"),
ggplot() + geom_sf(data=irq1, aes(fill=sar_pred_pop)) + ggtitle("Prediction from Population Density"),ncol=2)
```



#### Prediction Based on Civilian Death



```{r,message=FALSE, warning=FALSE, echo=FALSE}

irq_car = spautolm(formula = count ~ headcount, data = irq1, 
                  listw = listW, family = "CAR") 
irq_sar = spautolm(formula = count ~ headcount, data = irq1, 
                  listw = listW, family = "SAR")
irq1$car_pred = irq_car$fit$fitted.values
irq1$sar_pred = irq_sar$fit$fitted.values

irq1$car_resid = irq_car$fit$residuals
irq1$sar_resid = irq_sar$fit$residuals
grid.arrange(
ggplot() + geom_sf(data=irq1, aes(fill=count)) + ggtitle("Number of Attacks"),

ggplot() + geom_sf(data=irq1, aes(fill=headcount)) + ggtitle("# Civilian Deaths from Violence"),ncol=2
)
```


Given there is spatial pattern among terroristic attacks in Iraq, we use the number of civilian death from violence to predict the number of attack in Iraq. In this case, we use CAR and SAR by both Frequentist and Bayesian ways to predict it.

```{r,message=FALSE, warning=FALSE, echo=FALSE}
grid.arrange(
  ggplot() + geom_sf(data=irq1, aes(fill=car_pred)),
  ggplot() + geom_sf(data=irq1, aes(fill=sar_pred)),
  ggplot() + geom_sf(data=irq1, aes(fill=car_resid)),
  ggplot() + geom_sf(data=irq1, aes(fill=car_resid))
)
```

```{r,message=FALSE, warning=FALSE, echo=FALSE}

theme_set(
  theme_bw()  
)

get_coda_parameter = function(coda, pattern)
{
  w = coda[[1]] %>% colnames() %>% str_detect(pattern)
  coda[[1]][,w,drop=FALSE]
}

post_summary = function(m, ci_width=0.95)
{
  d = data_frame(
    post_mean  = apply(m, 2, mean),
    post_med   = apply(m, 2, median),
    post_lower = apply(m, 2, quantile, probs=(1-ci_width)/2),
    post_upper = apply(m, 2, quantile, probs=1 - (1-ci_width)/2)
  )
  
  if (!is.null(colnames(m)))
    d = d %>% mutate(param = colnames(m)) %>% dplyr::select(param, post_mean:post_upper)
  
  d
}

strip_attrs = function(obj)
{
  attributes(obj) = NULL
  obj
}

strip_class = function(obj)
{
  attr(obj,"class") = NULL
  obj
}
```



```{r,message=FALSE, warning=FALSE, echo=FALSE}
# JAGS CAR Model

y = irq1$count
x = irq1$headcount

W = W * 1L
D = diag(rowSums(W))

car_model = "model{
  y ~ dmnorm(beta0 + beta1*x, tau * (D - phi*W))
  y_pred ~ dmnorm(beta0 + beta1*x, tau * (D - phi*W))
  
  beta0 ~ dnorm(0, 1/100)
  beta1 ~ dnorm(0, 1/100)

  tau <- 1 / sigma2
  sigma2 ~ dnorm(0, 1/100) T(0,)
  phi ~ dunif(-0.99, 0.99)
}"
#cat(car_model,"\n")

if (!file.exists("irq_car_model.Rdata"))
{
  m = jags.model(
    textConnection(car_model), 
    data = list(
      D = D,
      y = y,
      x = x,
      W = W
    ),
    n.adapt=5000
  )

  update(m, n.iter=30000)#, progress.bar="none")
  
  irq_car_coda = coda.samples(
    m, variable.names=c("sigma2", "beta0", "beta1", "phi","y_pred"),
    n.iter=30000, thin=20
  )
  save(irq_car_coda, car_model, m, file="irq_car_model.Rdata")
} else {
  load("irq_car_model.Rdata")
}

beta_params = get_coda_parameter(irq_car_coda,"beta")
ar_params = get_coda_parameter(irq_car_coda,"sigma|phi")
y_pred = get_coda_parameter(irq_car_coda,"y_pred") %>% post_summary()
irq1$jags_pred = y_pred$post_mean
irq1$jags_resid = irq1$count - y_pred$post_mean
```


As the graphs show, the predicted maps are similar to the observed attack map. However, the predicted maps from the CAR and SAR models by Frequentist approach are more accurate than the models by Bayesian approach. Table.2 shows Car model by the Frequentist approach proforms best among all models in terms of RMSE. If considering Moran's I of Residual and Geary's C of Residual, SAR model by the Frequentist approach proforms best overall since there is almost no hidden spatial pattern in its residual.


```{r,message=FALSE, warning=FALSE, echo=FALSE}
grid.arrange(
  ggplot() + geom_sf(data=irq1, aes(fill=car_pred)),
  ggplot() + geom_sf(data=irq1, aes(fill=jags_pred)),
  ggplot() + geom_sf(data=irq1, aes(fill=car_resid)),
  ggplot() + geom_sf(data=irq1, aes(fill=jags_resid))
)

```

However, we can still observe some hidden spatial pattern from Moran's I of Residual and Geary's C of Residual in the JAGS models. Moreover, the RMSE of the JAGS models are also more than 40% higher than Frequentist models. We think it might be cause by limited iteration. The proformance of the JAGS model might be better, if we add more iterations.


| Model         | RMSE          | Moran's I of Residual| Geary's C of Residual|
| ------------- |:-------------:|:--------------------:|:--------------------:|
| SAR           | 295.02        | 0.01                 |1.11                  |
| CAR           | 273.29        | 0.30                 |0.76                  |
| SAR JAGS      | 422.51        | -0.32                |1.46                  |
| CAR JAGS      | 413.75        | 0.05                 |1.14                  |
Table: RMSE, Moran's I of Residual and Geary's C of Residual

####Spline model results

As mentioned before, spline model is like bending a sheet of rubber so that it passed through the points while minimizing the total curvature of the surface. Compared to the SAR and CAR models, the spline model can be able to capture the spatial pattern more precisely. Especially, for predicting ridges and valleys, the spline will perform much better than SAR and CAR model. In this project, spatial patterns for these terroristic attacks are highly similar to the rugged terrain since these attacks always take place in the area where it has high density of either population or energy. 


```{r,message=FALSE, warning=FALSE, echo=FALSE}
library(raster)
library(maptools)
data(wrld_simpl)
country=globalterrorismdb_0616dist[which(globalterrorismdb_0616dist$country==95),]
nal=-which(is.na(country$longitude))
country1=country[nal,]
r = raster(nrows=200, ncol=400,
           xmn = min(country1$longitude)*1.05, xmx = max(country1$longitude)*0.95,
           ymn = min(country1$latitude )*0.95, ymx = max(country1$latitude )*1.05)
country_iraq = rasterize(wrld_simpl[wrld_simpl$NAME == "Iraq",], r)
cells = which(!is.na(country_iraq []))
pred_coords = xyFromCell(r, cells)
library(fields)
#coords = select(csn, longitude, latitude) %>% as.matrix()
coords=country1[,c("longitude","latitude")] %>% as.matrix()

tps = Tps(x = coords, Y=country1$success)

iraqattack_pred = r
iraqattack_pred[cells] = predict(tps, pred_coords)


plot(iraqattack_pred,xlim=c(30,50),ylim=c(25,38))
points(coords, pch=16, cex=0.5)
title(main="spline model prediction",xlab="Longitude", ylab = "Latitude")


```


Instead of trying to explain the spatial patterns of terroristic attacks by using spline, we use spline to predict the spatial pattern of sucessful rate of attacks across the Iraq. As can be seen in the above plots, most of attacks concentrate on the middle of the Iraq with high successful rate. Not surprisingly, the capital city, baghdad, is also located in the center of Iraq. Just really a small amount of attacks took place on the south of Iraq but with high successful rate. However, although a lot of attacks took place on the northern provinces compard to the southern region, the succeful rate is relatively low.


